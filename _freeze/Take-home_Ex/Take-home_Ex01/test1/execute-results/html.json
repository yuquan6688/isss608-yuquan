{
  "hash": "04b3d2e9f05ad29561ab59e84d50d8c8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"test1\"\nformat: html\nexecute: \n  eval: true\n  echo: true\n  warning: false\n  freeze: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(ggrepel, patchwork, \n               ggthemes, hrbrthemes,\n               tidyverse, ggdist, ggridges, forcats) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- read_csv(\"data/respopagesex2024.csv\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# 通用预处理\ndata <- data %>%\n  mutate(\n    Age = if_else(Age == \"90_and_Over\", \"90\", as.character(Age)),\n    Age = as.numeric(Age)\n  )\n\n# ------------- 3.1 年龄结构 by PA ----------------\nv1 <- data %>%\n  mutate(\n    Age_Group = case_when(\n      Age <= 21 ~ \"Youth\",\n      Age < 65 ~ \"Middle\",\n      TRUE ~ \"Elderly\"\n    )\n  )\n\nv1_old_pa <- v1 %>%\n  group_by(PA) %>%\n  summarise(\n    Elderly = sum(Pop[Age >= 65], na.rm = TRUE),\n    Total = sum(Pop, na.rm = TRUE),\n    Elderly_Rate = Elderly / Total\n  ) %>%\n  filter(!is.na(Elderly_Rate)) %>%\n  arrange(desc(Elderly_Rate))\n\ntop_bottom_elderly <- bind_rows(\n  slice_max(v1_old_pa, Elderly_Rate, n = 10),\n  slice_min(v1_old_pa, Elderly_Rate, n = 10)\n) %>%\n  mutate(PA = fct_reorder(PA, Elderly_Rate))\n\nv1_young_pa <- v1 %>%\n  group_by(PA) %>%\n  summarise(\n    Youth = sum(Pop[Age <= 21], na.rm = TRUE),\n    Total = sum(Pop, na.rm = TRUE),\n    Youth_Rate = Youth / Total\n  ) %>%\n  arrange(desc(Youth_Rate))\n\ntop_bottom_youth <- bind_rows(\n  slice_max(v1_young_pa, Youth_Rate, n = 10),\n  slice_min(v1_young_pa, Youth_Rate, n = 10)\n) %>%\n  mutate(PA = fct_reorder(PA, Youth_Rate))\n\nv1_mid_pa <- v1 %>%\n  group_by(PA) %>%\n  summarise(\n    Middle = sum(Pop[Age > 21 & Age < 65], na.rm = TRUE),\n    Total = sum(Pop, na.rm = TRUE),\n    Middle_Rate = Middle / Total\n  ) %>%\n  arrange(desc(Middle_Rate))\n\ntop_bottom_middle <- bind_rows(\n  slice_max(v1_mid_pa, Middle_Rate, n = 10),\n  slice_min(v1_mid_pa, Middle_Rate, n = 10)\n) %>%\n  mutate(PA = fct_reorder(PA, Middle_Rate))\n\ncombined_df <- v1 %>%\n  group_by(PA, Age_Group) %>%\n  summarise(Pop = sum(Pop, na.rm = TRUE), .groups = \"drop\") %>%\n  group_by(PA) %>%\n  mutate(\n    Total = sum(Pop),\n    Ratio = Pop / Total\n  ) %>%\n  select(-Total) %>%\n  ungroup()\n\nordering <- combined_df %>%\n  filter(Age_Group == \"Middle\") %>%\n  arrange(desc(Ratio)) %>%\n  pull(PA)\n\ncombined_df <- combined_df %>%\n  filter(PA %in% ordering) %>%\n  mutate(PA = factor(PA, levels = ordering))\n\nage_group_totals <- v1 %>%\n  group_by(Age_Group) %>%\n  summarise(Pop = sum(Pop), .groups = \"drop\") %>%\n  mutate(\n    Prop = Pop / sum(Pop),\n    Percent = paste0(Age_Group, \": \", round(Prop * 100, 1), \"%\"),\n    xmin = cumsum(lag(Prop, default = 0)),\n    xmax = cumsum(Prop),\n    label_x = (xmin + xmax) / 2\n  )\n\n\n# ------------- 3.2 性别分布 ----------------\nv2 <- data %>%\n  mutate(\n    Age_Group = cut(\n      Age,\n      breaks = c(seq(0, 90, by = 5), Inf),\n      right = FALSE,\n      labels = c(\n        \"00_to_04\", \"05_to_09\", \"10_to_14\", \"15_to_19\", \"20_to_24\",\n        \"25_to_29\", \"30_to_34\", \"35_to_39\", \"40_to_44\", \"45_to_49\",\n        \"50_to_54\", \"55_to_59\", \"60_to_64\", \"65_to_69\", \"70_to_74\",\n        \"75_to_79\", \"80_to_84\", \"85_to_89\", \"90_and_over\"\n      )\n    )\n  )\n\nv2_p6 <- v2 %>%\n  group_by(Sex, Age_Group) %>%\n  summarise(Pop = sum(Pop), .groups = \"drop\") %>%\n  mutate(\n    Percent = Pop / sum(Pop) * 100,\n    Percent_plot = ifelse(Sex == \"Males\", Percent, -Percent)\n  )\n\nv2_p7 <- v2 %>%\n  group_by(PA, Sex) %>%\n  summarise(Pop = sum(Pop), .groups = \"drop\") %>%\n  group_by(PA) %>%\n  mutate(Total = sum(Pop)) %>%\n  ungroup() %>%\n  mutate(\n    Percent = Pop / Total * 100,\n    Percent_plot = ifelse(Sex == \"Males\", Percent, -Percent),\n    PA = fct_reorder(PA, Total)\n  )\n\nv2_p8 <- v2 %>%\n  group_by(PA, Sex) %>%\n  summarise(\n    Total = sum(Pop, na.rm = TRUE),\n    Elderly = sum(Pop[Age >= 65], na.rm = TRUE),\n    .groups = \"drop\"\n  ) %>%\n  mutate(\n    Elderly_Rate = ifelse(Total > 0, Elderly / Total * 100, 0),\n    Elderly_Rate_plot = ifelse(Sex == \"Males\", Elderly_Rate, -Elderly_Rate)\n  )\n\nvalid_PA <- v2_p8 %>%\n  group_by(PA) %>%\n  summarise(Total_Elderly = sum(Elderly)) %>%\n  filter(Total_Elderly > 0) %>%\n  pull(PA)\n\npa_avg <- v2_p8 %>%\n  filter(PA %in% valid_PA) %>%\n  group_by(PA) %>%\n  summarise(Avg_Elderly_Rate = mean(Elderly_Rate), .groups = \"drop\")\n\nselected_PA <- bind_rows(\n  slice_max(pa_avg, Avg_Elderly_Rate, n = 10),\n  slice_min(pa_avg, Avg_Elderly_Rate, n = 10)\n) %>%\n  pull(PA)\n\nv2_p8 <- v2_p8 %>%\n  filter(PA %in% selected_PA) %>%\n  mutate(PA = factor(PA, levels = rev(selected_PA)))\n\n\n# ------------- 3.3 Region 分布 ----------------\nregion_mapping <- tribble(\n  ~PA, ~Region,\n  \"Bishan\", \"Central\", \"Bukit Merah\", \"Central\", \"Bukit Timah\", \"Central\", \"Downtown Core\", \"Central\",\n  \"Geylang\", \"Central\", \"Kallang\", \"Central\", \"Marina East\", \"Central\", \"Marina South\", \"Central\",\n  \"Marine Parade\", \"Central\", \"Museum\", \"Central\", \"Newton\", \"Central\", \"Novena\", \"Central\",\n  \"Orchard\", \"Central\", \"Outram\", \"Central\", \"Queenstown\", \"Central\", \"River Valley\", \"Central\",\n  \"Rochor\", \"Central\", \"Singapore River\", \"Central\", \"Southern Islands\", \"Central\", \"Straits View\", \"Central\",\n  \"Tanglin\", \"Central\", \"Toa Payoh\", \"Central\", \"Bedok\", \"East\", \"Changi\", \"East\", \"Changi Bay\", \"East\",\n  \"Pasir Ris\", \"East\", \"Paya Lebar\", \"East\", \"Tampines\", \"East\", \"Central Water Catchment\", \"North\",\n  \"Lim Chu Kang\", \"North\", \"Mandai\", \"North\", \"Sembawang\", \"North\", \"Simpang\", \"North\",\n  \"Sungei Kadut\", \"North\", \"Woodlands\", \"North\", \"Yishun\", \"North\", \"Ang Mo Kio\", \"North-East\",\n  \"Hougang\", \"North-East\", \"North-Eastern Islands\", \"North-East\", \"Punggol\", \"North-East\",\n  \"Seletar\", \"North-East\", \"Sengkang\", \"North-East\", \"Serangoon\", \"North-East\", \"Boon Lay\", \"West\",\n  \"Bukit Batok\", \"West\", \"Bukit Panjang\", \"West\", \"Choa Chu Kang\", \"West\", \"Clementi\", \"West\",\n  \"Jurong East\", \"West\", \"Jurong West\", \"West\", \"Pioneer\", \"West\", \"Tengah\", \"West\", \"Tuas\", \"West\",\n  \"Western Islands\", \"West\", \"Western Water Catchment\", \"West\"\n)\n\n\nv3 <- data %>%\n  left_join(region_mapping, by = \"PA\") %>%\n  filter(!is.na(Region))\nv3_region <- v3\n\nv3_p9 <- v3 %>%\n  group_by(Region, Sex) %>%\n  summarise(Pop = sum(Pop), .groups = \"drop\") %>%\n  group_by(Region) %>%\n  mutate(\n    Total = sum(Pop),\n    Percent = Pop / Total * 100,\n    Label = paste0(format(Pop, big.mark = \",\"), \"\\n\", round(Percent, 1), \"%\"),\n    Pop_plot = ifelse(Sex == \"Males\", Pop, -Pop)\n  ) %>%\n  mutate(Region = fct_reorder(Region, Total))\n\nv3_p10 <- v3 %>%\n  uncount(weights = Pop)\n\nv3_p11 <- v3_p10 %>%\n  group_by(Region, Sex) %>%\n  sample_frac(0.0007)\n```\n:::\n\n\n\n\n\n## 3.1 Population Age Structure Across Singapore Planning Areas \n\n:::panel-tabset\n\n### The Plot\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](test1_files/figure-html/unnamed-chunk-4-1.png){width=960}\n:::\n:::\n\n\n\n### The Code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# elderly plot\np1 <- ggplot(top_bottom_elderly, aes(x = Elderly_Rate, y = PA, fill = Elderly_Rate)) +\n  geom_col() +\n  xlim(0, 0.35) +\n  scale_fill_viridis_c(option = \"C\") +\n  labs(\n    title = \"Top 10 & Bottom 10 Areas by Elderly Rate (≥ 65)\",\n    x = \"Elderly Ratio\",\n    y = \"Planning Area\"\n  ) +\n  theme_minimal()\n\n# youth plot\np2 <- ggplot(top_bottom_youth, aes(x = Youth_Rate, y = PA, fill = Youth_Rate)) +\n  geom_col() +\n  xlim(0, 0.35) +\n  scale_fill_viridis_c(option = \"C\") +\n  labs(\n    title = \"Top 10 & Bottom 10 Areas by Youth Rate (≤ 21)\",\n    x = \"Youth Ratio\",\n    y = \"Planning Area\"\n  ) +\n  theme_minimal()\n\n# middle plot\np3 <- ggplot(top_bottom_middle, aes(x = Middle_Rate, y = PA, fill = Middle_Rate)) +\n  geom_col() +\n  xlim(0, 1) +\n  scale_fill_viridis_c(option = \"C\") +\n  labs(\n    title = \"Top 10 & Bottom 10 Areas by Middle-aged Rate (22-64)\",\n    x = \"Middle-aged Ratio\",\n    y = \"Planning Area\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(size = 9, face = \"bold\", hjust = -10), \n    axis.text.y = element_text(size = 10)\n  )\n\n# Plot for each area\np4 <- ggplot(combined_df, aes(x = PA, y = Ratio, fill = Age_Group)) +\n  geom_bar(stat = \"identity\") +\n  coord_flip() +\n  labs(\n    title = \"Age Group Composition by Planning Area\",\n    x = \"Planning Area\",\n    y = \"Population Ratio\"\n  ) +\n  scale_fill_viridis_d(option = \"C\", begin = 0.2, end = 0.9) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(size = 14, face = \"bold\", hjust = 0),\n    axis.text.y = element_text(size = 7),\n    legend.position = \"right\"\n  )\n\n# Total Plot\np5 <- ggplot(age_group_totals) +\n  geom_rect(aes(xmin = xmin, xmax = xmax, ymin = 0, ymax = 1, fill = Age_Group)) +\n  geom_text(aes(x = label_x, y = 0.5, label = Percent), color = \"white\", size = 3, fontface = \"bold\") +\n  scale_fill_manual(values = c(\"Youth\" = \"#FDD75E\", \"Middle\" = \"#C94C5C\", \"Elderly\" = \"#5626A6\")) +\n  coord_cartesian(ylim = c(0, 1)) +\n  theme_void() +\n  ggtitle(\"Total Age Group Composition\") +\n  theme(\n    aspect.ratio = 0.05,  \n    plot.title = element_text(hjust = 0.5, size = 10, face = \"bold\"),\n    plot.margin = margin(0.2, 0.5, 0.2, 0.5, unit = \"cm\"),\n    legend.position = \"none\"\n  )\n\n\n\np5 / ((p1 / p2 / p3) | p4)\n```\n:::\n\n\n\n:::\n## 3.2 Gender-Based Demographics of Singapore Residents\n\n:::panel-tabset\n\n### The Plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](test1_files/figure-html/unnamed-chunk-6-1.png){width=960}\n:::\n:::\n\n\n\n### The Code\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# p6 \np6 <- ggplot(v2_p6, aes(x = Percent_plot, y = Age_Group, fill = Sex)) +\n  geom_col(width = 0.9) +\n  geom_text(aes(label = round(abs(Percent), 2)),\n            position = position_stack(vjust = 0.5),\n            size = 3.2, color = \"black\") +\n  scale_x_continuous(labels = function(x) paste0(abs(x), \"%\")) +\n  scale_fill_manual(values = c(\"Males\" = \"#58c3c3\", \"Females\" = \"#f08080\")) +\n  labs(\n    title = \"Population Pyramid: Singapore\",\n    x = \"Percentage of Population (%)\",\n    y = \"Age Group\",\n    fill = \"Sex\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(size = 16, face = \"bold\", hjust = 0.5),\n    axis.title = element_text(size = 12),\n    axis.text = element_text(size = 10)\n  )\n\n#p7\np7 <- ggplot(v2_p7, aes(x = Percent_plot, y = PA, fill = Sex)) +\n  geom_col(width = 0.8) +\n  geom_text(aes(label = round(abs(Percent), 1)),\n            position = position_stack(vjust = 0.5),\n            size = 3, color = \"black\") +\n  scale_x_continuous(labels = function(x) paste0(abs(x), \"%\")) +\n  scale_fill_manual(values = c(\"Males\" = \"#58c3c3\", \"Females\" = \"#f08080\")) +\n  labs(\n    title = \"Gender Composition by Planning Area\",\n    x = \"Percentage of Population (%)\",\n    y = \"Planning Area\",\n    fill = \"Sex\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(size = 16, face = \"bold\", hjust = 0.5),\n    axis.title = element_text(size = 12),\n    axis.text = element_text(size = 9)\n  )\n\n# p8\np8 <- ggplot(v2_p8, aes(x = Elderly_Rate_plot, y = PA, fill = Sex)) +\n  geom_col(width = 0.8) +\n  geom_text(aes(label = round(abs(Elderly_Rate), 1)),\n            position = position_stack(vjust = 0.5),\n            size = 3, color = \"black\") +\n  scale_x_continuous(labels = function(x) paste0(abs(x), \"%\")) +\n  scale_fill_manual(values = c(\"Males\" = \"#58c3c3\", \"Females\" = \"#f08080\")) +\n  labs(\n    title = \"Top 10 & Bottom 10 Areas by Elderly Rate (≥ 65), by Gender\",\n    x = \"Elderly Population Ratio (%)\",\n    y = \"Planning Area\",\n    fill = \"Sex\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(size = 15, face = \"bold\", hjust = 0.5),\n    axis.text.y = element_text(size = 9)\n  )\n\n\n(p6 / p8) | p7\n```\n:::\n\n\n\n:::\n\n\n## 3.3 Population Structure Across Singapore Regions\n\n:::panel-tabset\n### The Plot\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](test1_files/figure-html/unnamed-chunk-8-1.png){width=960}\n:::\n:::\n\n\n\n### The Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# p9\np9 <- ggplot(v3_p9, aes(x = Pop_plot, y = Region, fill = Sex)) +\n  geom_col(width = 0.85) +\n  geom_text(aes(label = Label),\n            position = position_stack(vjust = 0.5),\n            size = 3.5,\n            color = \"black\") +\n  scale_x_continuous(labels = scales::label_number(scale = 1/1000, suffix = \"K\", big.mark = \",\")) +\n  scale_fill_manual(values = c(\"Males\" = \"#a6cee3\", \"Females\" = \"#f4a6a6\")) +\n  labs(\n    title = \"Gender by Region\",\n    x = NULL,\n    y = NULL,\n    fill = \"Sex\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(size = 16, face = \"bold\"),\n    axis.title = element_text(size = 12),\n    axis.text = element_text(size = 11),\n    legend.position = \"top\"\n  )\n\n# p10\np10 <- ggplot(v3_p10, aes(x = Age, y = Region, fill = Sex)) +\n  geom_density_ridges(\n    alpha = 0.5,\n    scale = 1.2,\n    color = \"white\",\n    position = \"identity\"\n  ) +\n  scale_fill_manual(values = c(\"Males\" = \"#58c3c3\", \"Females\" = \"#f08080\")) +\n  labs(\n    title = \"Age Distribution by Region (Gender Overlay)\",\n    x = \"Age\",\n    y = \"Region\",\n    fill = \"Sex\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16, hjust = 0.5),\n    axis.title = element_text(size = 12),\n    axis.text.y = element_text(size = 10)\n  )\n\n# p11\np11 <- ggplot() +\n  geom_boxplot(\n    data = v3_p10,\n    aes(x = Region, y = Age, color = Sex),\n    position = position_dodge(width = 0.75),\n    outlier.shape = NA\n  ) +\n  geom_point(\n    data = v3_p11,\n    aes(x = Region, y = Age, color = Sex),\n    position = position_jitterdodge(jitter.width = 0.3, dodge.width = 0.75),\n    size = 0.5,\n    alpha = 0.4\n  ) +\n  scale_color_manual(values = c(\"Males\" = \"#58c3c3\", \"Females\" = \"#f08080\")) +\n  labs(\n    title = \"Age Distribution by Region and Gender (Sampled)\",\n    x = \"Region\",\n    y = \"Age\",\n    color = \"Sex\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16, hjust = 0.5),\n    axis.title = element_text(size = 12),\n    axis.text = element_text(size = 10),\n    legend.position = \"top\"\n  )\n\n(p9 + p10) / p11\n```\n:::\n",
    "supporting": [
      "test1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}